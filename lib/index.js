"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var mysql=require("mysql"),helper_1=require("./helper"),MySQLDbProvider=function(){function e(e){this.options=e,this.connection=e.connection}return e.prototype.dashDocumentToDashModel=function(e){return{config:JSON.parse(e.Config),description:e.Description,id:e.Id.toString(),layout:JSON.parse(e.Layout),title:e.Title,shareWith:e.ShareWith}},e.prototype.dashletDocumentToModel=function(e){return{configuration:JSON.parse(e.Configuration),dashboardId:e.DashboardId,description:e.Description,id:e.Id.toString(),moduleId:e.ModuleId,title:e.Title}},e.prototype.searchDashboards=function(e,t){var r=this;t=t||{limit:100,startFrom:0},t.limit=Math.min(t.limit,100),t.startFrom=parseInt(t.startFrom),e=e||{};var o=[];e.appid&&o.push("AppId IN (?)"),e.user&&o.push("User IN (?)");var n=this;return new Promise(function(i,a){var s="SELECT * FROM dashboard WHERE ";s+=o.join(" and "),s+=" order by CreatedAt DESC ",s+="LIMIT "+t.startFrom+","+(t.limit+1);var u=[];e.appid&&(e.appid instanceof Array?u.push(e.appid):u.push([e.appid])),e.user&&(e.user instanceof Array?u.push(e.user):u.push([e.user])),r.connection.query(s,u,function(e,r,o){if(e)a(e);else{var s=!1;r.length>t.limit&&(s=!0,r.splice(r.length-1,1));var u={data:r.map(n.dashDocumentToDashModel),hasMore:s};i(u)}})})},e.prototype.getDashboard=function(e,t){var r=this,o=this;return new Promise(function(n,i){r.connection.query("SELECT * FROM dashboard WHERE AppId = ? and Id = ?",[e,t],function(e,t,r){if(e)i(e);else{if(t.length){var a=o.dashDocumentToDashModel(t[0]);return o.searchDashlets({dashboardId:a.id}).then(function(e){n({dashboard:a,dashlets:e})})}n(null)}})})},e.prototype.createDashboard=function(e){var t=this,r={AppId:e.appid,Title:e.title,ShareWith:e.shareWith,Description:e.description,User:e.user,CreatedAt:helper_1.default.utcNow(),Config:JSON.stringify(e.config||{}),Layout:JSON.stringify(e.layout||{})};return new Promise(function(e,o){t.connection.query("INSERT INTO dashboard SET ?",r,function(t,r,n){if(t)o(t);else{var i={id:r.insertId.toString()};e(i)}})})},e.prototype.deleteDashboard=function(e,t){var r=this;return new Promise(function(o,n){r.connection.query("DELETE FROM dashboard WHERE AppId = ? and Id = ?",[e,t],function(e,t,r){e?n(e):o(t.affectedRows)})})},e.prototype.updateDashboard=function(e,t,r){var o=this;return new Promise(function(n,i){var a=[];r.config&&a.push({Col:"Config",Val:JSON.stringify(r.config)}),r.description&&a.push({Col:"Description",Val:r.description}),r.layout&&a.push({Col:"Layout",Val:JSON.stringify(r.layout)}),r.shareWith&&a.push({Col:"ShareWith",Val:r.shareWith}),r.title&&a.push({Col:"Title",Val:r.title});for(var s="",u=0;u<a.length;u++)s+=a[u].Col+" = "+mysql.escape(a[u].Val)+", ";s=s.substr(0,s.length-2),o.connection.query("UPDATE dashboard SET "+s+" WHERE AppId = ? and Id = ?",[e,t],function(e,t,r){e?i(e):n(t.affectedRows)})})},e.prototype.createDashlet=function(e){var t=this,r={DashboardId:e.dashboardId,Configuration:JSON.stringify(e.configuration||{}),ModuleId:e.moduleId,Title:e.title,Description:e.description,CreatedAt:helper_1.default.utcNow()};return new Promise(function(e,o){t.connection.query("INSERT INTO dashlet SET ?",r,function(t,r,n){if(t)o(t);else{var i={id:r.insertId.toString()};e(i)}})})},e.prototype.deleteDashlet=function(e){var t=this;e instanceof Array||(e=[e]);return new Promise(function(r,o){t.connection.query("DELETE FROM dashlet WHERE Id IN (?)",[e],function(e,t,n){e?o(e):r(t.affectedRows)})})},e.prototype.updateDashlet=function(e,t){var r=this;return new Promise(function(o,n){var i=[];t.configuration&&i.push({Col:"Configuration",Val:JSON.stringify(t.configuration)}),t.description&&i.push({Col:"Description",Val:t.description}),t.title&&i.push({Col:"Title",Val:t.title});for(var a="",s=0;s<i.length;s++)a+=i[s].Col+" = "+mysql.escape(i[s].Val)+", ";a=a.substr(0,a.length-2),r.connection.query("UPDATE dashlet SET "+a+" WHERE  Id = ?",[e],function(e,t,r){e?n(e):o(t.affectedRows)})})},e.prototype.searchDashlets=function(e){var t=this,r=[];e.user instanceof Array?r.push({Clause:" User IN (?) ",Value:e.user}):e.user&&r.push({Clause:" User = ? ",Value:e.user}),e.dashboardId&&r.push({Clause:" DashboardId = ?",Value:e.dashboardId});var o="SELECT * FROM dashlet WHERE ",n=[];for(var i in r)o+=r[i].Clause,n.push(r[i].Value);o+=" order by CreatedAt desc ";var a=this;return new Promise(function(e,r){t.connection.query(o,n,function(t,o,n){if(t)r(t);else{var i=o.map(a.dashletDocumentToModel);e(i)}})})},e}();exports.MySQLDbProvider=MySQLDbProvider,exports.default=function(e){return new MySQLDbProvider(e)};